(function(){if(!window["BX"]||window["BX"]["MPLForm"]||!window["app"])return;var e=window["BX"],t={form:{},list:{},comments:{}},i=function(e,t){return e+"-"+(t>0?t:"0")};var n={keyBoardIsShown:false,mention:{}},s=function(e,t,i){if(!!i&&typeof i=="object"){for(var n in i){if(i.hasOwnProperty(n)){s(e,t+"["+n+"]",i[n])}}}else{e.append(t,!!i?i:"")}};window.app.exec("enableCaptureKeyboard",true);e.addCustomEvent("onKeyboardWillShow",function(){n.keyBoardIsShown=true});e.addCustomEvent("onKeyboardDidHide",function(){n.keyBoardIsShown=false});var o=function(e,t,i){this.id=e;this.text=t||"";this.attachments=i||[];this.mentions={}};o.prototype={text:"",attachments:[],node:null,getText:function(){var e=this.text;for(var t in this.mentions){if(this.mentions.hasOwnProperty(t)){e=e.replace(new RegExp(t,"gi"),this.mentions[t])}}return e}};o.getInstance=function(i,n,s){var r=null;if(!e.type.isArray(i)&&i&&i["___id"]&&t["comments"][i["___id"]]){r=i}else if(t["comments"][i.join("-")]){r=t["comments"][i.join("-")]}else{r=new o(i,n,s);r.___id=i.join("-");t["comments"][i.join("-")]=r}return r};o.removeInstance=function(e){if(e&&e["___id"])delete t["comments"][e["___id"]]};var r=function(i){this.bindEvents();t["form"][this.handlerId]=this;this.entitiesId={};this.comment=null;this.handlerId=i;this.handler=null;this.handlerEvents={onMPFUserIsWriting:e.delegate(this.writing,this),onMPFHasBeenDestroyed:e.delegate(this.reboot,this)};this.visible=false;this.bindHandler=e.delegate(this.bindHandler,this);e.addCustomEvent(window,"onMPFIsInitialized",this.bindHandler);if(e["MPF"])this.bindHandler(e["MPF"].getInstance(this.handlerId))};r.prototype={bindHandler:function(t){if(t&&t.id==this.handlerId){this.handler=t;e.removeCustomEvent(window,"onMPFIsInitialized",this.bindHandler);for(var i in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(i)){e.addCustomEvent(this.handler,i,this.handlerEvents[i])}}this.closeWait();e.onCustomEvent(this,"OnUCFormInit",[this])}},bindEvents:function(){this.windowEvents={OnUCUserReply:e.delegate(function(e,t,i){if(this.entitiesId[e]){var n=[e,0];t=parseInt(t);if(t>0&&i){n=this.initComment(n,"",false);n.mentions[i]="[USER="+t+"]"+i+"[/USER]";var s=this.handler&&this.handler.simpleForm?this.handler.simpleForm.writingParams["~text"]:n.text;n.text=s+(s==""?"":" ")+i+", "}this.show(n,n.text,false)}},this),OnUCAfterRecordEdit:e.delegate(function(e,t,i,n){if(this.entitiesId[e]){if(n==="EDIT"){this.show([e,t],i["messageBBCode"],i["messageFields"])}else if(i["errorMessage"]){this.showError([e,t],i["errorMessage"])}else if(i["okMessage"]){this.showNote([e,t],i["okMessage"])}}},this)};e.addCustomEvent(window,"OnUCUserReply",this.windowEvents.OnUCUserReply);e.addCustomEvent(window,"OnUCAfterRecordEdit",this.windowEvents.OnUCAfterRecordEdit)},reboot:function(t,i,n){for(var s in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(s)){e.removeCustomEvent(this.handler,s,this.handlerEvents[s])}}this.bindHandler(n)},linkEntity:function(t,i){if(this.handler===null){this._linkEntity=e.delegate(function(){this.linkEntity(t,i)},this);e.addCustomEvent(this,"OnUCFormInit",this._linkEntity)}else{if(this["_linkEntity"])e.removeCustomEvent(this,"OnUCFormInit",this["_linkEntity"]);this.entitiesId[t]=i;this.comment=this.reinitComment({id:[t,0]});this.handler.init(this.comment)}},writing:function(t){e.onCustomEvent(window,"OnUCUserIsWriting",[t["id"][0],t["id"][1]])},reinitComment:function(e){var t=[e["id"][0],0];o.removeInstance(e);return this.initComment(t,"",[])},initComment:function(t,i,n){var s=o.getInstance(t,i,n);if(s["bound"]!=="Y"){e.addCustomEvent(s,"onCancel",e.delegate(e.delegate(this.submitClear,this)));e.addCustomEvent(s,"onStart",e.delegate(e.delegate(this.submitStart,this)));e.addCustomEvent(s,"onSubmit",e.delegate(e.delegate(this.submit,this)));e.addCustomEvent(s,"onError",e.delegate(e.delegate(function(e,t){this.showError(s,t);this.submitClear(s)},this)));s["bound"]="Y"}return s},show:function(t,i,n){this.comment=this.initComment(t,i,n);e.onCustomEvent(this.handler,"OnUCFormBeforeShow",[this,i,n]);this.handler.show(this.comment,!!n);e.onCustomEvent(this.handler,"OnUCFormAfterShow",[this,i,n]);return true},submitClear:function(e){o.removeInstance(e);if(this.comment==e){this.comment=this.initComment([e.id[0],0],"",[]);this.handler.init(this.comment)}},submitStart:function(t,i,n){e.onCustomEvent(window,"OnUCFormBeforeSubmit",[t.id[0],t.id[1],t,this,i,n])},submit:function(t){var i=t.getText(),n=t.attachments,o=this.entitiesId[t.id[0]],r=this.handler.getForm({ENTITY_XML_ID:t.id[0],REVIEW_TEXT:i,NOREDIRECT:"Y",MODE:"RECORD",AJAX_POST:"Y",id:t.id,sessid:e.bitrix_sessid()}),a=new window.MobileAjaxWrapper,d=new window.FormData,l;if(t.id[1]>0){r["REVIEW_ACTION"]="EDIT";r["FILTER"]={ID:t.id[1]};if(r["act"]){r["act"]="edit";r["edit_id"]=t.id[1]}}if(o["fields"]){for(l in o["fields"]){if(o["fields"].hasOwnProperty(l)){r[l]=o["fields"][l]}}}e.onCustomEvent(window,"OnUCFormSubmit",[t.id[0],t.id[1],this,r]);for(l in r){if(r.hasOwnProperty(l)){s(d,l,r[l])}}if(n){for(var h=0;h<n.length;h++){s(d,n[h]["fieldName"],n[h]["fieldValue"])}}a.Wrap({method:"POST",url:o["url"],data:{},type:"json",processData:true,start:false,preparePost:false,callback:e.proxy(function(i){e.onCustomEvent(window,"OnUCFormResponse",[t.id[0],t.id[1],this,i,t]);if(i["errorMessage"])this.showError(t,i["errorMessage"]);else e.onCustomEvent(window,"OnUCAfterRecordAdd",[t.id[0],t.id[1],this,i,t])},this),callback_failure:e.delegate(function(i){e.onCustomEvent(window,"OnUCFormResponse",[t.id[0],t.id[1],this,i,t]);this.showError(t,"Uncorrect server responce.")},this)});a.xhr.send(d);this.submitClear(t)},showError:function(t,i){if(e.type.isArray(t))t=this.initComment(t,"",[]);var n;i='<div class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+"<b>"+e.message("FC_ERROR")+"</b><br />"+i+"</div>";if(t&&t.node){e.addClass(t.node,"feed-com-block-cover-undelivered");n=e.findChild(t.node,{tagName:"DIV",className:"post-comment-text"},true);if(n)n.innerHTML+=i}else if(i){}},showNote:function(e,t){},showWait:function(){this.handler.hide();this.handler.showWait()},closeWait:function(){this.handler.closeWait()}};r.link=function(e,i){var n=i["id"];t["form"][n]=t["form"][n]||new r(n);t["form"][n].linkEntity(e,i)};window.mobileShowActions=function(n,s,o){o=o||window.event;if(!window.app.enableInVersion(10)){return true}if(o&&o.target&&o.target.tagName&&(o.target.tagName.toUpperCase()=="A"||o.target.tagName.toUpperCase()=="IMG"&&e.type.isNotEmptyString(o.target.getAttribute("data-bx-image")))){return true}e.eventCancelBubble(o);e.PreventDefault(o);var r=e("record-"+i(n,s)),a=[],d;if(r.getAttribute("bx-mpl-reply-show")=="Y")a.push({title:e.message("BLOG_C_REPLY"),callback:function(){t["list"][n].reply(e("record-"+i(n,s)+"-reply-action"))}});var l;if(r.getAttribute("bx-mpl-vote-id")!="#VOTE_ID#"&&window["RatingLikeComments"]&&(l=window.RatingLikeComments.getById(r.getAttribute("bx-mpl-vote-id")))&&l){l["__delegatedVoteFunc"]=l["__delegatedVoteFunc"]||e.delegate(l.vote,l);a.push({title:l.voted?e.message("BPC_MES_VOTE2"):e.message("BPC_MES_VOTE1"),callback:l["__delegatedVoteFunc"]});a.push({title:e.message("BPC_MES_VOTE"),callback:function(){window.RatingLikeComments.List(r.getAttribute("bx-mpl-vote-id"))}})}if(r.getAttribute("bx-mpl-edit-show")=="Y")a.push({title:e.message("BPC_MES_EDIT"),callback:function(){t["list"][n].act(r.getAttribute("bx-mpl-edit-url"),s,"EDIT")}});if(r.getAttribute("bx-mpl-moderate-show")=="Y"){var h=r.getAttribute("bx-mpl-moderate-approved")=="hidden";a.push({title:h?e.message("BPC_MES_SHOW"):e.message("BPC_MES_HIDE"),callback:function(){t["list"][n].act(r.getAttribute("bx-mpl-moderate-url").replace("#action#",h?"show":"hide").replace("#ACTION#",h?"SHOW":"HIDE"),s,"MODERATE")}})}if(r.getAttribute("bx-mpl-delete-show")=="Y")a.push({title:e.message("BPC_MES_DELETE"),callback:function(){t["list"][n].act(r.getAttribute("bx-mpl-delete-url"),s,"DELETE")}});if(a.length>0){d=new window.BXMobileApp.UI.ActionSheet({buttons:a},"commentSheet");d.show()}return false};window.mobileReply=function(i,n){e.eventCancelBubble(n);e.PreventDefault(n);t["list"][i].reply(n.target);return false};var a=function(i){e.MPL=function(n,s,o){e.MPL.superclass.constructor.apply(this,arguments);this.template=e.message("MPL_RECORD_TEMPLATE");this.thumb=e.message("MPL_RECORD_THUMB");this.thumbForFile=e.message("MPL_RECORD_THUMB_FILE");e.removeCustomEvent(i,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);e.removeCustomEvent(i,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);this.postCounter=0;this.windowEvents["OnUCFormBeforeSubmit"]=e.delegate(function(e,t,i,n,s,o){if(this.ENTITY_XML_ID==e){var r=[e,t>0?t:"new_"+this.postCounter++];this.makeThumb(r,i,s,o);this.pullNewRecords[e+"-"+t]="busy"}},this);this.windowEvents["OnUCAfterRecordAdd"]=e.delegate(function(e,t,i,n,s){if(this.ENTITY_XML_ID==e){this.add(s,n["messageId"],n,true,"simple")}},this);this.windowEvents["OnUCFormResponse"]=e.delegate(function(e,t,i,n,s){if(this.ENTITY_XML_ID==e){this.pullNewRecords[e+"-0"]="ready";this.pullNewRecords[e+"-"+t]="done";this.clearThumb(s)}},this);this.windowEvents["onPull"]=e.delegate(function(t){var i=t.params;if(t.module_id=="unicomments"&&t.command=="comment_mobile"&&i["ENTITY_XML_ID"]==this.ENTITY_XML_ID&&i["USER_ID"]+""!=e.message("USER_ID")+""){if(t.command=="comment_mobile"&&i["ID"])this.pullNewRecord(i);else if(t.command=="answer")this.pullNewAuthor(i["USER_ID"],i["NAME"],i["AVATAR"])}},this);e.addCustomEvent(i,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);e.addCustomEvent(i,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);e.addCustomEvent(i,"OnUCFormBeforeSubmit",this.windowEvents["OnUCFormBeforeSubmit"]);e.addCustomEvent(i,"onPull",this.windowEvents["onPull"]);if(s["SHOW_POST_FORM"]=="Y")r.link(this.ENTITY_XML_ID,o);t["list"][this.ENTITY_XML_ID]=this;return this};e.extend(e.MPL,i["FCList"]);e.MPL.prototype.init=function(){};e.MPL.prototype.makeThumb=function(t,n,s,o){var r=n.node||e("record-"+t.join("-")+"-cover");if(!r){var a=e.type.isString(s)?s:"";a=e.util.htmlspecialchars(a).replace(/\n/gi,"<br />");a=a.replace(/\001/,"").replace(/(\[\/user\])/gi,"").replace(/\[user=(\d+)\]([^\001]?.+)(\001)/gi,"$2").replace(/\001/,"[/user]");var d=i.fcParseTemplate({messageFields:{FULL_ID:t,POST_MESSAGE_TEXT:a,POST_TIMESTAMP:(new Date).getTime()/1e3}},{DATE_TIME_FORMAT:this.params.DATE_TIME_FORMAT,RIGHTS:this.rights},a==""?this.thumbForFile:this.thumb),l;l=e.processHTML(d,false);r=e.create("DIV",{attrs:{id:"record-"+t.join("-")+"-cover",className:"feed-com-block-cover"},style:{opacity:0,height:0,overflow:"hidden"},html:l.HTML});e("record-"+t[0]+"-new").appendChild(r);var h=r,m=e.pos(h);i.scrollTo(0,m.top);var c=e.GetWindowScrollPos(),u=e.GetWindowInnerSize();new e["easing"]({duration:1e3,start:{opacity:0,height:0},finish:{opacity:100,height:h.scrollHeight},transition:e.easing.makeEaseOut(e.easing.transitions.quart),step:function(e){h.style.height=e.height+"px";h.style.opacity=e.opacity/100;if(c.scrollTop>0&&m.top<c.scrollTop+u.innerHeight){i.scrollTo(0,c.scrollTop+e.height)}},complete:function(){h.style.cssText=""}}).animate();var f=0,p=function(){f++;if(f<100){var i=e("record-"+t.join("-")+"-cover");if(i&&i.childNodes.length>0)e.ajax.processScripts(l.SCRIPT);else e.defer(p,this)()}};e.defer(p,this)()}e.addClass(r,"feed-com-block-cover-wait");n.node=r;return r};e.MPL.prototype.clearThumb=function(t){if(t&&e(t.node)){e.removeClass(t.node,"feed-com-block-cover-wait")}};e.MPL.prototype.add=function(t,n,s){if(e.type.isArray(t)){e.MPL.superclass.add.apply(this,arguments)}else if(e(t["node"])){t["node"].setAttribute("id","record-"+n.join("-")+"-cover");e.MPL.superclass.add.apply(this,[n,s,true,"simple"])}else{e.MPL.superclass.add.apply(this,[n,s])}if(i["BitrixMobile"]&&i["BitrixMobile"]["LazyLoad"])setTimeout(function(){i.BitrixMobile.LazyLoad.showImages()},500)};e.MPL.prototype.send=function(){if(e(this.nav))e.addClass(this.nav.parentNode,"post-comments-button-waiter");e.MPL.superclass.send.apply(this,arguments)};e.MPL.prototype.build=function(){if(e(this.nav))e.removeClass(this.nav.parentNode,"post-comments-button-waiter");e.MPL.superclass.build.apply(this,arguments)};e.MPL.prototype.complete=function(){if(e(this.nav))e.removeClass(this.nav.parentNode,"post-comments-button-waiter");e.MPL.superclass.complete.apply(this,arguments)};e.MPL.prototype.showWait=function(t){var i=e("record-"+this.ENTITY_XML_ID+"-"+t+"-cover");if(t>0&&i)e.addClass(i,"feed-com-block-cover-wait")};e.MPL.prototype.closeWait=function(t){var i=e("record-"+this.ENTITY_XML_ID+"-"+t+"-cover");if(t>0&&i)e.removeClass(i,"feed-com-block-cover-wait")};e.MPL.createInstance=function(t,i,n){return new e.MPL(t,i,n)};e.MPL.getInstance=function(e){return t["list"][e]};e.addCustomEvent(i,"OnUCHasBeenDestroyed",function(e){delete t["list"][e]});e.onCustomEvent("main.post.list/mobile",["script.js"]);e.removeCustomEvent("main.post.list/default",function(){a(i)})};e.addCustomEvent("main.post.list/default",function(){a(window)});if(window["FCList"])a(window)})();
//# sourceMappingURL=script.map.js